<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple WebRTC Softphone</title>
  <script src="jssip-3.10.0.min.js"></script>
</head>
<body>
  <h2>Simple WebRTC Softphone</h2>

  <div>
    <label for="sipUri">SIP URI (e.g., sip:username@domain): </label>
    <input type="text" id="sipUri" placeholder="sip:1000@loupdb.com" value="sip:1000@loupdb.com">
    <br><br>
    <label for="sipPassword">Password: </label>
    <input type="password" id="sipPassword" placeholder="Password" value="UF1RdHNG">
    <br><br>
    <label for="sipServer">WebSocket Server (Outbound Proxy, e.g., wss://your-sip-server.com:8089/ws): </label>
    <input type="text" id="sipServer" placeholder="wss://alpha.netsapiens.com:8001/ws" value="wss://alpha.netsapiens.com:8001">
    <br><br>
    <button onclick="registerSipClient()">Register</button>
    <br><br>
  </div>

  <div id="call-controls" style="display:none;">
    <label for="callNumber">Call Number: </label>
    <input type="text" id="callNumber" placeholder="Number to call">
    <br><br>
    <button onclick="makeCall()">Call</button>
    <button onclick="hangupCall()">Hang Up</button>
    <br><br>
  </div>

  <div id="captions" style="border: 1px solid black; padding: 10px; width: 300px; height: 100px; overflow-y: auto;">
  <p id="transcript"></p>
  </div>

  <script>
  let userAgent;
  let currentSession;
  let recognition;

  function startSpeechRecognition() {
    if (!('webkitSpeechRecognition' in window)) {
      alert('Your browser does not support the Web Speech API');
      return;
    }

    recognition = new webkitSpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-US';

    recognition.onresult = function(event) {
      let transcript = '';
      for (let i = event.resultIndex; i < event.results.length; i++) {
        transcript += event.results[i][0].transcript;
      }
      document.getElementById('transcript').innerText = transcript;
    };

    recognition.onerror = function(event) {
      console.error('Speech recognition error', event);
    };

    recognition.start();
  }

  function registerSipClient() {
    const sipUri = document.getElementById('sipUri').value;
    const sipPassword = document.getElementById('sipPassword').value;
    const sipServer = document.getElementById('sipServer').value;

    if (!sipUri || !sipPassword || !sipServer) {
      alert('Please enter all the required details.');
      return;
    }

    try {
      const socket = new JsSIP.WebSocketInterface(sipServer);
      const configuration = {
        sockets: [socket],
        uri: sipUri,
        password: sipPassword
      };

      userAgent = new JsSIP.UA(configuration);
      userAgent.start();

      userAgent.on('registered', () => {
        alert('SIP client registered successfully!');
        document.getElementById('call-controls').style.display = 'block';
      });

      userAgent.on('newRTCSession', (data) => {
        currentSession = data.session;

        if (currentSession.direction === 'incoming') {
          currentSession.answer({ mediaConstraints: { audio: true, video: false } });
        }

        startSpeechRecognition(); // Start transcribing when the call starts

        currentSession.on('ended', () => {
          currentSession = null;
          if (recognition) {
            recognition.stop(); // Stop transcription when the call ends
          }
        });
      });

    } catch (error) {
      console.error('Error during SIP client registration:', error);
      alert('Failed to initialize SIP client. Please check the WebSocket URL and try again.');
    }
  }

  function makeCall() {
    const callNumber = document.getElementById('callNumber').value;

    if (!callNumber) {
      alert('Please enter the number to call.');
      return;
    }

    currentSession = userAgent.call('sip:' + callNumber + '@' + userAgent.configuration.uri.split('@')[1], {
      mediaConstraints: { audio: true, video: false }
    });

    currentSession.on('ended', () => {
      currentSession = null;
      if (recognition) {
        recognition.stop(); // Stop transcription when the call ends
      }
    });
  }

  function hangupCall() {
    if (currentSession) {
      currentSession.terminate();
      if (recognition) {
        recognition.stop(); // Stop transcription when the call ends
      }
    }
  }
</script>

</body>
</html>
